<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Городской Транспорт</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f8f8;
      margin: 0;
      padding: 0;
      color: #000;
      overflow-x: hidden;
    }
    .container {
      max-width: 420px;
      margin: 0 auto;
      background: #fff;
      min-height: 100vh;
      padding: 20px 16px;
      box-sizing: border-box;
    }
    header {
      text-align: center;
      margin-bottom: 24px;
    }
    h1 {
      color: #d32f2f;
      font-size: 24px;
      margin: 0;
    }
    .input-wrapper {
      margin: 24px 0;
    }
    label {
      display: block;
      font-size: 16px;
      margin-bottom: 8px;
      text-align: center;
    }
    input {
      width: 100%;
      font-size: 36px;
      text-align: center;
      letter-spacing: 12px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 12px;
      box-sizing: border-box;
      background: #fafafa;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      color: white;
      background: #d32f2f;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin: 16px 0;
      transition: background 0.2s;
    }
    button:hover { background: #b71c1c; }
    #ticket {
      display: none;
      border-top: 8px solid #d32f2f;
      padding-top: 20px;
    }
    .ticket-header {
      background: #d32f2f;
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 18px;
      border-radius: 8px 8px 0 0;
      margin: -20px -16px 16px -16px;
    }
    .ticket-body {
      padding: 0 8px;
    }
    .row {
      display: flex;
      justify-content: space-between;
      margin: 12px 0;
      font-size: 16px;
    }
    .label { font-weight: bold; color: #555; }
    .value { text-align: right; }
    .timer {
      font-size: 40px;
      font-weight: bold;
      color: #d32f2f;
      text-align: center;
      margin: 24px 0;
    }
    #qrcode {
      text-align: center;
      margin: 20px 0;
    }
    .present-btn {
      background: #388e3c !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Городской Транспорт</h1>
      <p style="color:#666; margin-top:8px;">mini app</p>
    </header>

    <div class="input-wrapper">
      <label>Введите код с наклейки</label>
      <input type="text" id="code" maxlength="6" placeholder="524858" pattern="\d{6}" inputmode="numeric">
    </div>

    <button onclick="generateFakeTicket()">Создать билет</button>

    <div id="ticket">
      <div class="ticket-header">✅ Данные билета</div>
      <div class="ticket-body">
        <div class="row"><span class="label">Перевозчик</span><span class="value">ИП Цугленок М.М.</span></div>
        <div class="row"><span class="label">Маршрут</span><span class="value">83, Дом учёных - пр. Ульяновский</span></div>
        <div class="row"><span class="label">Гос. номер</span><span class="value">х377тх124</span></div>
        <div class="row"><span class="label">Тариф</span><span class="value">Полный - 48.00 ₽</span></div>
        <div class="row"><span class="label">Контроль</span><span class="value" id="ctrlNum">1 401 070 339</span></div>
        <div class="row"><span class="label">Дата покупки</span><span class="value">12 февраля 2026 г.</span></div>
        <div class="row"><span class="label">Время покупки</span><span class="value">18:56</span></div>
      </div>

      <div class="timer" id="timer">Действует: 14 сек.</div>

      <div id="qrcode"></div>

      <button class="present-btn" onclick="presentTicket()">Предъявить билет</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
if (tg) {
      tg.ready();
      tg.expand();
      tg.MainButton.setText("Закрыть").show().onClick(() => tg.close());
    }

    let timerId;

    function generateFakeTicket() {
      const code = document.getElementById('code').value.trim();
      if (code.length !== 6 || !/^\d{6}$/.test(code)) {
        alert('Введи ровно 6 цифр!');
        return;
      }

      // Рандом контрольный номер в стиле твоего скрина
      const randPart = Math.floor(100000 + Math.random() * 900000).toString();
      const ctrl = 1 401 ${randPart.slice(0,3)} ${randPart.slice(3)};
      document.getElementById('ctrlNum').textContent = ctrl;

      document.getElementById('ticket').style.display = 'block';

      // Таймер 14 сек
      let sec = 14;
      const timerEl = document.getElementById('timer');
      clearInterval(timerId);
      timerId = setInterval(() => {
        sec--;
        timerEl.textContent = Действует: ${sec} сек.;
        if (sec <= 0) {
          clearInterval(timerId);
          timerEl.textContent = 'Билет истёк';
          document.getElementById('qrcode').innerHTML = '<p style="color:red; text-align:center; font-size:18px;">QR-код недействителен</p>';
        }
      }, 1000);

      // Генерация QR (с данными для вида)
      const qrData = BUS:${code} CTRL:${ctrl} ROUTE:83 COST:48 DATE:2026-02-12 TIME:18:56 VALID:14s;
      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'), {
        text: qrData,
        width: 240,
        height: 240,
        colorDark: "#000",
        colorLight: "#fff"
      });
    }

    function presentTicket() {
      alert('Показывай экран контролёру сейчас — таймер идёт!');
      // Можно добавить полноэкранный QR, но для простоты alert
    }
  </script>
</body>
</html>
